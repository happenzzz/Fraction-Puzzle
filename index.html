<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>ë¶„ìˆ˜ í¼ì¦ ì§€ìš°ê¸° (8Â·16Â·25ì¡°ê°)</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
<style>
  :root{
    --accent:#ff6b9e;   /* ê·€ì—¬ìš´ í•‘í¬ */
    --accent2:#7dd3fc;  /* í•˜ëŠ˜ í¬ì¸íŠ¸ */
    --tile:#222;        /* í¼ì¦íŒ ìƒ‰ (ë°°ê²½ ì™„ì „ ê°€ë¦¼) */
    --tileText:#fff;
    --ok:#22c55e;
    --bad:#f97316;
  }
  html,body{height:100%;margin:0;background:linear-gradient(135deg,#0ea5e9 0%,#f9a8d4 100%) fixed;font-family:"Jua",system-ui,"Noto Sans KR",sans-serif;color:#fff}
  .app{display:flex;flex-direction:column;height:100vh;gap:10px;padding:12px}
  header{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  header h1{font-size:clamp(20px,5.4vw,34px);margin:0 8px 0 0; text-shadow:0 3px 0 #0003}
  .stageButtons{display:flex;gap:8px;flex-wrap:wrap}
  .pill{
    background:#00000028; border:1px solid #ffffff33; padding:10px 14px; border-radius:999px; font-weight:900; backdrop-filter:blur(6px)
  }
  button{
    background:var(--accent); color:#fff; border:none; padding:12px 18px; border-radius:16px;
    font-weight:900; box-shadow:0 8px 18px #0004; cursor:pointer; transform:translateZ(0);
    transition:transform .06s ease, filter .06s ease;
  }
  button:active{transform:translateY(2px) scale(.98); filter:brightness(.95)}
  button.secondary{background:#00000028; border:1px solid #ffffff35}
  .hud{margin-left:auto;display:flex;gap:8px;align-items:center}
  .boardWrap{position:relative;flex:1;min-height:300px;border-radius:18px;overflow:hidden;background:#000;box-shadow:0 12px 30px #0005}
  .boardBg{position:absolute; inset:0; background:#000 center/cover no-repeat; filter:saturate(1); transform:translateZ(0)}
  .tiles{position:absolute; inset:0;}
  .tile{
    position:absolute; display:flex; align-items:center; justify-content:center;
    background:var(--tile); color:var(--tileText);
    border:0; border-radius:14px; user-select:none; -webkit-user-select:none;
    font-size:clamp(22px,4.8vw,42px); font-weight:900; letter-spacing:.2px;
    box-shadow:0 0 0 .6px #000 inset, 0 0 0 1px #000;
    transition:opacity .22s ease, transform .2s ease, filter .2s ease, background .2s ease;
  }
  .tile small{opacity:.98; transform:translateY(-1px)}
  .tile.hint{outline:3px dashed #fff8; outline-offset:-4px; animation:hint 1s infinite}
  @keyframes hint{0%,100%{filter:none}50%{filter:brightness(1.25)}}
  .tile.solved{opacity:0; pointer-events:none; transform:scale(.92); transition:opacity .28s ease, transform .28s ease}

  .tray{
    position:relative; border-radius:18px; background:#00000028;
    border:1px solid #ffffff33; padding:12px; overflow:hidden; backdrop-filter:blur(8px);
    box-shadow:inset 0 0 0 1px #ffffff1a;
  }
  .heartsArea{position:relative; min-height:120px}
  .heart{
    position:absolute; width:180px; min-width:150px; padding:16px 18px 20px;
    text-align:center; color:#fff; cursor:grab; touch-action:none;
    transform:translate(-50%,-50%); will-change:transform;
    filter:drop-shadow(0 10px 14px #0005);
    transition:transform .12s ease, opacity .2s ease, left .15s ease, top .15s ease;
    animation:float 3s ease-in-out infinite;
  }
  .heart.grabbing{cursor:grabbing; transform:translate(-50%,-50%) scale(1.06) rotate(-1.5deg)}
  @keyframes float{0%,100%{transform:translate(-50%,-50%) translateY(0)}50%{transform:translate(-50%,-50%) translateY(-6px)}}
  /* í•˜íŠ¸ ëª¨ì–‘ */
  .heart::before, .heart::after{
    content:""; position:absolute; width:64%; height:64%; left:18%; top:18%;
    background:var(--accent); border-radius:50% 50% 0 0; transform:rotate(-45deg);
    box-shadow:0 10px 24px #ff6b9e66, inset 0 -8px 16px #0003;
  }
  .heart::after{left:auto; right:18%; transform:rotate(45deg)}
  .heart > span{
    position:relative; z-index:2; display:inline-block;
    padding:12px 14px; border-radius:12px; background:#0007; box-shadow:0 3px 10px #0007;
    font-size:clamp(22px,5vw,44px); font-weight:900; white-space:nowrap;
  }
  .heart.bad{animation:shake .28s}
  @keyframes shake{0%{transform:translate(-50%,-50%) rotate(0)}25%{transform:translate(calc(-50% - 7px),-50%) rotate(-3deg)}75%{transform:translate(calc(-50% + 7px),-50%) rotate(3deg)}100%{transform:translate(-50%,-50%) rotate(0)}}
  .lives{
    position:absolute; z-index:3; left:50%; top:100%; transform:translate(-50%,-6px);
    display:flex; gap:6px; padding:4px 8px; border-radius:999px; background:#0007; font-size:14px
  }
  .lifeDot{width:10px; height:10px; border-radius:50%; background:#fff9; box-shadow:0 0 0 2px #0004 inset}
  .lifeDot.off{background:#0002}

  .footerBar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:8px}
  .legend{opacity:.95}
  .toast{
    position:fixed; left:50%; bottom:16px; transform:translateX(-50%);
    background:#000000cc; border:1px solid #ffffff33; color:#fff; padding:10px 14px; border-radius:12px;
    box-shadow:0 10px 30px #0006; display:none; font-weight:800
  }
  .toast.show{display:block; animation:fade .18s}
  @keyframes fade{from{opacity:0; transform:translateX(-50%) translateY(8px)} to{opacity:1; transform:translateX(-50%) translateY(0)}}

  /* ì‘ì€ ë°˜ì§ì´ */
  .spark{position:absolute; pointer-events:none; font-size:24px; animation:spark 800ms ease forwards}
  @keyframes spark{0%{opacity:0; transform:translateY(10px) scale(.6)}30%{opacity:1}100%{opacity:0; transform:translateY(-30px) scale(1.2)}}

  @media (max-width:768px){
    .heart{width:160px}
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>ë¶„ìˆ˜ í¼ì¦ ì§€ìš°ê¸°</h1>
    <div class="stageButtons">
      <button class="pill stageBtn" data-stage="1">1ë‹¨ê³„ Â· 8ì¡°ê°</button>
      <button class="pill stageBtn" data-stage="2">2ë‹¨ê³„ Â· 16ì¡°ê°</button>
      <button class="pill stageBtn" data-stage="3">3ë‹¨ê³„ Â· 25ì¡°ê°</button>
    </div>
    <div class="hud">
      <button id="reloadBg" class="secondary pill">ë°°ê²½ ìƒˆë¡œê³ ì¹¨</button>
      <div class="pill" id="progress">ì™„ë£Œ 0/0</div>
    </div>
  </header>

  <div class="boardWrap" id="boardWrap">
    <!-- ë°°ê²½ì€ íƒ€ì¼ ì•„ë˜ì—ë§Œ ìˆê³ , íƒ€ì¼ì´ ì™„ì „íˆ ë®ì–´ ê°€ë¦°ë‹¤ -->
    <div class="boardBg" id="boardBg"></div>
    <div class="tiles" id="tiles"></div>
  </div>

  <div class="tray">
    <div class="heartsArea" id="heartsArea"></div>
    <div class="footerBar">
      <div class="legend">í•˜íŠ¸ë¥¼ ì •ë‹µ íƒ€ì¼ ìœ„ë¡œ ëŒì–´ë‘ë©´ ê·¸ ì¡°ê°ì´ â€œíˆ­â€ ì‚¬ë¼ì§€ë©° ê·¸ë¦¼ì´ ë³´ì—¬ìš”. (ì˜¤ë‹µ 3ë²ˆ â†’ í•´ë‹¹ í•˜íŠ¸ ì‚¬ë¼ì§)</div>
      <div>
        <button id="shuffleBtn" class="secondary">í•˜íŠ¸ ì„ê¸°</button>
        <button id="resetBtn">ì²˜ìŒë¶€í„°</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* -------------------- ë‹¨ê³„ë³„ ë¬¸ì œ ì„¸íŠ¸ --------------------
   - 1ë‹¨ê³„: í†µë¶„/ì•½ë¶„ ë¶ˆí•„ìš”(ê¸°ë³¸)
   - 2Â·3ë‹¨ê³„: ë§ì…ˆì€ 'ì˜¬ë¦¼', ëº„ì…ˆì€ 'ë¹Œë¦¼'ì´ ë°˜ë“œì‹œ ë‚˜ì˜¤ë„ë¡ êµ¬ì„±
   - ëª¨ë“  ë¶„ëª¨ëŠ” í†µë¶„ì´ í•„ìš” ì—†ë„ë¡ ë™ì¼í•˜ê²Œ ì œì‹œ
------------------------------------------------------------ */
const STAGES = {
  1: { rows:2, cols:4, // 8ì¡°ê°
       pairs: [
        {q:"2/5 + 1/5", a:"3/5"},
        {q:"7/9 + 1/9", a:"8/9"},
        {q:"6/11 - 2/11", a:"4/11"},
        {q:"3/7 + 3/7", a:"6/7"},
        {q:"5/8 - 2/8", a:"3/8"},
        {q:"1 2/9 + 2 3/9", a:"3 5/9"},
        {q:"4 3/7 - 1 1/7", a:"3 2/7"},
        {q:"2 5/12 + 1 2/12", a:"3 7/12"},
       ]
     },
  2: { rows:4, cols:4, // 16ì¡°ê° â€” ì˜¬ë¦¼/ë¹Œë¦¼ í¬í•¨
       pairs: [
        {q:"2 5/7 + 1 6/7", a:"4 4/7"},   // ì˜¬ë¦¼
        {q:"4 2/9 - 1 7/9", a:"2 4/9"},   // ë¹Œë¦¼
        {q:"1 8/11 + 2 6/11", a:"4 3/11"},// ì˜¬ë¦¼
        {q:"5 1/7 - 2 6/7", a:"2 2/7"},   // ë¹Œë¦¼
        {q:"3 7/11 + 1 5/11", a:"5 1/11"},// ì˜¬ë¦¼
        {q:"6 3/11 - 2 9/11", a:"3 5/11"},// ë¹Œë¦¼
        {q:"2 9/13 + 1 8/13", a:"4 4/13"},// ì˜¬ë¦¼
        {q:"7 2/13 - 3 9/13", a:"3 6/13"},// ë¹Œë¦¼
        {q:"1 9/17 + 3 12/17", a:"5 4/17"},// ì˜¬ë¦¼
        {q:"5 4/17 - 2 13/17", a:"2 8/17"},// ë¹Œë¦¼
        {q:"3 6/7 + 1 6/7", a:"5 5/7"},   // ì˜¬ë¦¼
        {q:"4 1/9 - 1 8/9", a:"2 2/9"},   // ë¹Œë¦¼
        {q:"2 8/9 + 1 5/9", a:"4 4/9"},   // ì˜¬ë¦¼
        {q:"3 3/11 - 1 9/11", a:"1 5/11"},// ë¹Œë¦¼
        {q:"1 7/13 + 2 12/13", a:"4 6/13"},// ì˜¬ë¦¼
        {q:"6 2/7 - 4 6/7", a:"1 3/7"},   // ë¹Œë¦¼
       ]
     },
  3: { rows:5, cols:5, // 25ì¡°ê° â€” ì˜¬ë¦¼/ë¹Œë¦¼ í¬í•¨
       pairs: [
        {q:"3 4/7 + 2 6/7", a:"6 3/7"},   // ì˜¬ë¦¼
        {q:"5 2/11 - 2 8/11", a:"2 5/11"},// ë¹Œë¦¼
        {q:"1 9/13 + 2 8/13", a:"4 4/13"},// ì˜¬ë¦¼
        {q:"4 1/7 - 1 5/7", a:"2 3/7"},   // ë¹Œë¦¼
        {q:"2 7/11 + 3 7/11", a:"6 3/11"},// ì˜¬ë¦¼
        {q:"6 3/13 - 2 11/13", a:"3 5/13"},// ë¹Œë¦¼
        {q:"1 3/5 + 2 4/5", a:"4 2/5"},   // ì˜¬ë¦¼
        {q:"7 4/9 - 4 8/9", a:"2 5/9"},   // ë¹Œë¦¼
        {q:"4 8/9 + 1 5/9", a:"6 4/9"},   // ì˜¬ë¦¼
        {q:"3 1/5 - 1 4/5", a:"1 2/5"},   // ë¹Œë¦¼
        {q:"2 5/7 + 1 6/7", a:"4 4/7"},   // ì˜¬ë¦¼
        {q:"5 3/11 - 3 9/11", a:"1 5/11"},// ë¹Œë¦¼
        {q:"3 9/17 + 1 11/17", a:"5 3/17"},// ì˜¬ë¦¼
        {q:"8 2/13 - 3 10/13", a:"4 5/13"},// ë¹Œë¦¼
        {q:"4 7/13 + 2 9/13", a:"7 3/13"},// ì˜¬ë¦¼
        {q:"6 1/7 - 3 6/7", a:"2 2/7"},   // ë¹Œë¦¼
        {q:"1 8/11 + 1 7/11", a:"3 4/11"},// ì˜¬ë¦¼
        {q:"5 1/13 - 2 9/13", a:"2 5/13"},// ë¹Œë¦¼
        {q:"2 4/5 + 3 4/5", a:"6 3/5"},   // ì˜¬ë¦¼
        {q:"9 3/17 - 4 12/17", a:"4 8/17"},// ë¹Œë¦¼
        {q:"5 6/7 + 2 5/7", a:"8 4/7"},   // ì˜¬ë¦¼
        {q:"7 2/11 - 5 9/11", a:"1 4/11"},// ë¹Œë¦¼
        {q:"3 8/13 + 1 9/13", a:"5 4/13"},// ì˜¬ë¦¼
        {q:"4 2/5 - 2 4/5", a:"1 3/5"},   // ë¹Œë¦¼
        {q:"2 9/11 + 1 7/11", a:"4 5/11"},// ì˜¬ë¦¼
       ]
     }
};

/* -------------------- ì „ì—­ ìƒíƒœ -------------------- */
let currentStage = 1;
let solvedCount = 0;
let hearts = [];  // DOM refs
let tiles = [];   // DOM refs

/* ìì‚° í´ë” ë°°ê²½: íŒŒì¼ëª…ì„ ê³ ì •ìœ¼ë¡œ ì‚¬ìš© */
const stageImages = {
  1: 'asset/stage1.png',
  2: 'asset/stage2.png',
  3: 'asset/stage3.png'
};

/* -------------------- ìœ í‹¸ -------------------- */
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
function toast(msg){
  const t = $('#toast');
  t.textContent = msg; t.classList.add('show');
  clearTimeout(t._id); t._id = setTimeout(()=>t.classList.remove('show'), 1300);
}
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=(Math.random()*(i+1))|0; [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function sparkAt(x,y,text='âœ¨'){
  const s = document.createElement('div');
  s.className='spark'; s.textContent=text;
  s.style.left = x+'px'; s.style.top = y+'px';
  document.body.appendChild(s);
  setTimeout(()=>s.remove(), 820);
}

/* í•˜íŠ¸ ê²¹ì¹¨ ë°©ì§€ ë ˆì´ì•„ì›ƒ (ë°˜ì‘í˜• ê·¸ë¦¬ë“œ) */
function layoutHeartsNoOverlap(jitter=true){
  const area = $('#heartsArea');
  const rect = area.getBoundingClientRect();
  const W = rect.width || area.clientWidth || 600;

  const cellW = 190;           // í•˜íŠ¸ í­ + ì—¬ë°± ê¸°ì¤€
  const cellH = 130;           // í•˜íŠ¸ ë†’ì´ + ì—¬ë°± ê¸°ì¤€
  const cols = Math.max(1, Math.floor(W / cellW));
  const rows = Math.ceil(hearts.length / cols);

  // íŠ¸ë ˆì´ ë†’ì´ë¥¼ ìë™ í™•ì¥
  area.style.minHeight = Math.max(120, rows * cellH + 20) + 'px';

  hearts.forEach((h, idx)=>{
    const col = idx % cols;
    const row = Math.floor(idx / cols);
    const jx = jitter ? (Math.random()*16 - 8) : 0;
    const jy = jitter ? (Math.random()*10 - 5) : 0;
    const x = Math.round(col*cellW + cellW/2 + jx);
    const y = Math.round(row*cellH + cellH/2 + jy);
    h.style.left = x+'px';
    h.style.top  = y+'px';
    h.dataset.homeX = x; h.dataset.homeY = y;
  });
}

/* -------------------- ìŠ¤í…Œì´ì§€ ë¹Œë“œ -------------------- */
function setBoardBg(url){
  $('#boardBg').style.backgroundImage = url ? `url(${url})` : 'none';
}
function buildStage(stageId){
  currentStage = stageId;
  const stage = STAGES[stageId];
  const pairs = stage.pairs.slice();
  solvedCount = 0;

  // ë°°ê²½ ì ìš© (íƒ€ì¼ ì•„ë˜, ì²˜ìŒì—” ì „ë¶€ ê°€ë ¤ì§)
  setBoardBg(stageImages[stageId] || '');

  // ë¦¬ì…‹
  $('#tiles').innerHTML = '';
  $('#heartsArea').innerHTML = '';
  hearts = []; tiles = [];

  // í¼ì¦ íƒ€ì¼ ìƒì„± â€” ì‹œì‘ ì‹œ ê·¸ë¦¼ ì™„ì „ ê°€ë¦¼
  const r = stage.rows, c = stage.cols;
  const total = r*c;
  const useN = Math.min(total, pairs.length);
  const picked = pairs.slice(0, useN);

  $('#progress').textContent = `ì™„ë£Œ ${solvedCount}/${useN}`;

  const tilesEl = $('#tiles');
  for(let i=0;i<useN;i++){
    const row = Math.floor(i / c);
    const col = i % c;
    const tile = document.createElement('div');
    tile.className = 'tile';
    tile.dataset.answer = picked[i].a;
    tile.innerHTML = `<small>${picked[i].a}</small>`;

    const w = 100/c, h = 100/r;
    tile.style.left = `${col*w}%`;
    tile.style.top  = `${row*h}%`;
    tile.style.width = `${w}%`;
    tile.style.height= `${h}%`;

    tilesEl.appendChild(tile);
    tiles.push(tile);
  }

  // í•˜íŠ¸(ë¬¸ì œ) ìƒì„±
  const heartsArea = $('#heartsArea');

  shuffle(picked).forEach((p)=>{
    const heart = document.createElement('div');
    heart.className = 'heart';
    heart.dataset.answer = p.a;
    heart.dataset.wrong = '0'; // ì˜¤ë‹µ íšŸìˆ˜
    heart.innerHTML = `<span>${p.q}</span>`;
    // ëª©ìˆ¨ UI
    const lives = document.createElement('div');
    lives.className = 'lives';
    lives.innerHTML = `<div class="lifeDot"></div><div class="lifeDot"></div><div class="lifeDot"></div>`;
    heart.appendChild(lives);

    heartsArea.appendChild(heart);
    makeDraggable(heart);
    hearts.push(heart);
  });

  // ì²« ë°°ì¹˜: ê²¹ì¹¨ ì—†ì´
  layoutHeartsNoOverlap(false);

  toast(`${stageId}ë‹¨ê³„ ì‹œì‘! ì¡°ê° ${useN}ê°œ`);
}

/* -------------------- ë“œë˜ê·¸/ë“œë¡­ -------------------- */
function updateLives(heartEl){
  const wrong = +heartEl.dataset.wrong;
  const dots = $$('.lifeDot', heartEl);
  dots.forEach((d,i)=> d.classList.toggle('off', i < wrong));
}
function makeDraggable(el){
  let dragging=false;

  const onDown = (e)=>{
    dragging=true; el.classList.add('grabbing');
    el.setPointerCapture(e.pointerId);
  };
  const onMove = (e)=>{
    if(!dragging) return;
    const area = $('#heartsArea').getBoundingClientRect();
    const x = e.clientX - area.left;
    const y = e.clientY - area.top;
    el.style.left = x+'px';
    el.style.top  = y+'px';

    const hit = tileHit(el);
    tiles.forEach(t=>t.classList.remove('hint'));
    if(hit) hit.classList.add('hint');
  };
  const onUp = (e)=>{
    if(!dragging) return;
    dragging=false; el.classList.remove('grabbing');
    const hit = tileHit(el);
    tiles.forEach(t=>t.classList.remove('hint'));

    if(hit){
      const ok = (hit.dataset.answer.trim() === el.dataset.answer.trim());
      if(ok){
        const r = hit.getBoundingClientRect();
        hit.classList.add('solved');
        sparkAt(r.left + r.width/2, r.top + r.height/2, 'ğŸ’–');

        el.remove(); // í•˜íŠ¸ ì œê±°
        solvedCount++; $('#progress').textContent = `ì™„ë£Œ ${solvedCount}/${tiles.length}`;
        tiles.forEach(t=>!t.classList.contains('solved') && (t.style.background = '#2a2a2a'));

        if(solvedCount===tiles.length){
          toast('ëª¨ë‘ ì„±ê³µ! ê·¸ë¦¼ì´ ì™„ì „íˆ ë³´ì˜€ì–´ìš” âœ¨');
          celebratoryBurst();
        }else{
          toast('ì •ë‹µ! ì¡°ê°ì´ ì‚¬ë¼ì¡Œì–´ìš”');
        }
        return;
      }else{
        // ì˜¤ë‹µ ì²˜ë¦¬ (3íšŒ ëˆ„ì  ì‹œ í•˜íŠ¸ ì†Œë©¸)
        let wrong = (+el.dataset.wrong)||0;
        wrong++; el.dataset.wrong = String(wrong);
        updateLives(el);
        el.classList.add('bad'); setTimeout(()=>el.classList.remove('bad'), 260);
        toast(wrong>=3 ? 'ê¸°íšŒ ì†Œì§„! í•´ë‹¹ ë¬¸ì œëŠ” ì‚¬ë¼ì¡Œì–´ìš”' : `ë‹¤ë¥¸ ìë¦¬ì˜ˆìš” (ì˜¤ë‹µ ${wrong}/3)`);

        if(wrong>=3){
          sparkAt(e.clientX, e.clientY, 'ğŸ’¨');
          el.style.opacity = '0'; setTimeout(()=>el.remove(), 180);
          return;
        }
      }
    }
    // ì›ìœ„ì¹˜
    el.style.left = el.dataset.homeX+'px';
    el.style.top  = el.dataset.homeY+'px';
  };

  el.addEventListener('pointerdown', onDown);
  el.addEventListener('pointermove', onMove);
  el.addEventListener('pointerup', onUp);
  el.addEventListener('pointercancel', onUp);
}
function tileHit(heartEl){
  const tilesLeft = tiles.filter(t=>!t.classList.contains('solved'));
  const hRect = heartEl.getBoundingClientRect();
  const hcx = hRect.left + hRect.width/2;
  const hcy = hRect.top  + hRect.height/2;
  for(const t of tilesLeft){
    const r = t.getBoundingClientRect();
    if(hcx>=r.left && hcx<=r.right && hcy>=r.top && hcy<=r.bottom){
      return t;
    }
  }
  return null;
}

/* ì¶•í•˜ ì´í™íŠ¸ ê°„ë‹¨ ë²„ìŠ¤íŠ¸ */
function celebratoryBurst(){
  const rect = $('#boardWrap').getBoundingClientRect();
  for(let i=0;i<28;i++){
    const x = rect.left + Math.random()*rect.width;
    const y = rect.top + rect.height*0.3 + Math.random()*rect.height*0.4;
    setTimeout(()=>sparkAt(x,y, Math.random()<.5?'âœ¨':'ğŸ’«'), Math.random()*520);
  }
}

/* -------------------- UI ë°”ì¸ë”© -------------------- */
$('.stageButtons').addEventListener('click', (e)=>{
  const btn = e.target.closest('.stageBtn'); if(!btn) return;
  buildStage(+btn.dataset.stage);
});

$('#shuffleBtn').addEventListener('click', ()=>{
  shuffle(hearts);
  layoutHeartsNoOverlap(true); // ê²¹ì¹¨ ì—†ì´ ì¬ë°°ì¹˜ + ì•½ê°„ì˜ ì§€í„°
  toast('í•˜íŠ¸ë¥¼ ì„ì—ˆì–´ìš”');
});

$('#resetBtn').addEventListener('click', ()=> buildStage(currentStage));

/* ìì‚° í´ë” ìƒˆë¡œê³ ì¹¨(íŒŒì¼ êµì²´ í›„ ìºì‹œ ë¬´ì‹œ) */
$('#reloadBg').addEventListener('click', ()=>{
  const t = Date.now();
  Object.keys(stageImages).forEach(k=>{
    const base = stageImages[k].split('?')[0];
    stageImages[k] = `${base}?v=${t}`;
  });
  setBoardBg(stageImages[currentStage]);
  toast('ë°°ê²½ì„ ìƒˆë¡œê³ ì¹¨í–ˆì–´ìš”');
});

/* ì°½ í¬ê¸° ë³€ê²½ ì‹œ í•˜íŠ¸ ì¬ë°°ì¹˜(ê²¹ì¹¨ ë°©ì§€) */
window.addEventListener('resize', ()=> layoutHeartsNoOverlap(false));

/* ì´ˆê¸° ì§„ì… */
buildStage(1);
</script>
</body>
</html>
